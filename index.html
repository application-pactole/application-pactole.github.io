<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Conduit</title>

  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="fonts/fa-solid.css">

  <!--
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Signika:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Signika+Negative:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Open Sans:wght@400;700&display=swap" rel="stylesheet">
  -->

  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;700&display=swap" rel="stylesheet">

  <script src="elm.js"></script>
</head>

<body>
  <script>
    var accounts
    try {
      accounts = JSON.parse (localStorage.getItem ("accounts"))
    } catch (e) {
      console.error (e)
      accounts = []
    }

    var account
    if (accounts instanceof Array && accounts.length > 0 && typeof accounts[0] == "string") {
      account = accounts[0]
    }

    function getLedger (account) {
      var result
      if (account !== null) {
        var key = "ledger." + account
        try {
          result = JSON.parse (localStorage.getItem (key))
        } catch (e) {
          console.error (e)
          result = null
        }
      }
      return result
    }
    var ledger = getLedger (account)


    var flags = {
      accounts: accounts,
      ledger: ledger
    }
    var app = Elm.Main.init({flags: flags})

    app.ports.selectAccount.subscribe(function(name) {
      console.log("selectAccount " + name)
      account = name
      app.ports.ledger.send (getLedger (account))
    })

    app.ports.setLedger.subscribe(function(args) {
      [name, ledger] = args
      console.log("setLedger " + name)
      var key = "ledger." + name
      localStorage.setItem(key, JSON.stringify(ledger))
    })

    // Whenever localStorage changes in another tab, report it if necessary.
    window.addEventListener("storage", function(event) {
      console.log ("Storage event!")
      if (event.storageArea === localStorage) {
        console.log ("LOCAL storage event!")
        let v = JSON.parse(event.newValue)
        //TODO: handle JSON.parse exceptions
        switch (event.key) {
          case "accounts":
            app.ports.accounts.send(v)
        }
        //TODO: propagate ledger-keys changes
      }
    })


    /*
    app.ports.storeCache.subscribe(function(val) {

      if (val === null) {
        localStorage.removeItem(storageKey);
      } else {
        localStorage.setItem(storageKey, JSON.stringify(val));
      }

      // Report that the new session was stored successfully.
      setTimeout(function() { app.ports.onStoreChange.send(val); }, 0);
    });
    */

  </script>
</body>

</html>
