<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pactole</title>

  <!-- meta http-equiv="Content-Security-Policy" content="style-src 'self'; script-src 'self'; default-src 'self'"-->

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="application-name" content="Pactole">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" sizes="512x512" href="images/icon-512x512.png">

  <!--link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;700&display=swap" rel="stylesheet"-->

  <style>
  @font-face {
    font-family: 'Font Awesome 5 Free';
    font-style: normal;
    font-weight: 900;
    font-display: swap;
    src: url("fonts/fa-solid-900.woff2");
  }
  @font-face {
    font-family: 'Work Sans';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url("fonts/work-sans-v7-latin-regular.woff2");
  }
  @font-face {
    font-family: 'Work Sans';
    font-style: normal;
    font-weight: 700;
    font-display: swap;
    src: url("fonts/work-sans-v7-latin-700.woff2");
  }
  </style>
  <script src="elm.js"></script>
</head>

<body>
  <script>

    // PROGRESSIVE WEB APP ////////////////////////////////////////////////////


    navigator.storage.persist().then(persistent => {
      if (persistent) {
        navigator.storage.estimate().then(info => {
          log(
            `Persistent storage: usage = ${Math.round(
              info.usage / 1024,
            )} kb, (quota = ${Math.round(info.quota / (1024*1024))} Mb).`,
          )
        })
      } else {
        //TODO: what?
        error('FATAL: This application requires persistent storage')
      }
    })


    if (!('indexedDB' in window)) {
      error('IndexedDB not supported by browser.')
      throw new Error('IndexedDB not supported by browser.')
    }


    if (!('serviceWorker' in navigator)) {
      error('Service workers are not supported by the navigator.')
      throw new Error('Service workers are not supported by the navigator.')
    }


    //TODO: add a settings button to call this?
    let updateService


    onload = () => {
      navigator.serviceWorker
        .register('./service.js')
        .then(registration => {
          updateService = () => registration.update()
          if (registration.installing) {
            log(
              `Service registration: installing (scope: ${registration.scope})`,
            )
          } else if (registration.waiting) {
            log(
              `Service registration: waiting (scope: ${registration.scope})`,
            )
          } else if (registration.active) {
            log(
              `Service registration: active (scope: ${registration.scope})`,
            )
          }
          registration.onupdatefound = () => {
            let w = registration.installing
            log(`Update found: installation in progress...`)
            w.onstatechange = event => {
              if (event.target.state === 'installed') {
                log(`The update has been installed.`)
              }
            }
          }
        })
        .catch(err => error(`Service registration failed: ${err}`))
    }

    //navigator.serviceWorker.startMessages()


    let service


    navigator.serviceWorker
      .ready
      .then(registration => {
        log(`Application started.`)
        service = registration.active
        navigator.serviceWorker.onmessage = event => {
          log(`Received "${event.data.title}" from service.`)
          app.ports.receive.send([event.data.title, event.data.content])
        }
        app.ports.receive.send(["service worker ready", null])
      })
      .catch(err => error(`Service worker not ready: ${err}`))


    // ELM STUFF //////////////////////////////////////////////////////////////


    let app
    {
      let today = new Date ()

      let flags = {
        today: {
          year: today.getFullYear (),
          month: today.getMonth (),
          day: today.getDate ()
        }
      }
      app = Elm.Main.init({flags: flags})
    }
 

    app.ports.send.subscribe(function(args) {
      [title, content] = args
      if (title == "error") {
        console.error (`[ELM] ${content}`)
        return
      }
      log(`Sending "${title}" to service...`)
      return service.postMessage({ title: title, content: content })
    })


    // UTILITIES //////////////////////////////////////////////////////////////


    function log(msg) {
      console.log(`[JS] ${msg}`)
    }


    function error(msg) {
      console.error(`[JS] ${msg}`)
    }


  </script>
</body>

</html>
